"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
class WallabySettings {
    constructor(_wallaby, _project, _setup, _settingsCallback) {
        this._wallaby = _wallaby;
        this._project = _project;
        this._setup = _setup;
        this._settingsCallback = _settingsCallback;
        this.createFiles();
        this.createTests();
        this.createCompilers();
    }
    get settings() {
        let settings = {
            files: this.files,
            tests: this.tests,
            compilers: this.compilers,
            setup: this._setup.setup,
            testFramework: 'mocha',
            env: {
                type: 'node',
                runner: 'node'
            },
        };
        if (typeof this._settingsCallback === 'function')
            this._settingsCallback(this._wallaby, settings);
        return settings;
    }
    get files() {
        if (this._files === undefined)
            this.createFiles();
        return this._files;
    }
    get tests() {
        if (this._tests === undefined)
            this.createTests();
        return this._tests;
    }
    get compilers() {
        if (this._compilers === undefined)
            this.createCompilers();
        return this._compilers;
    }
    createFiles() {
        this._files = [];
        this._files.push(...this.getBaseFiles());
        let sources = this._project.sources;
        this.globsAsRelativeGlobs(sources.declarationFilesGlobs.includes).forEach(glob => this._files.push({ pattern: glob, ignore: true }));
        this.globsAsRelativeGlobs(sources.compiledFilesGlobs.includes).forEach(glob => this._files.push({ pattern: glob, ignore: true }));
        this.globsAsRelativeGlobs(sources.testFileGlobs.includes).forEach(glob => this._files.push({ pattern: glob, ignore: true }));
        this.globsAsRelativeGlobs(sources.testSetupFileGlobs.includes).forEach(glob => this._files.push({ pattern: glob, instrument: false }));
        this.globsAsRelativeGlobs(sources.sourceFileGlobs.includes).forEach(glob => this._files.push({ pattern: glob }));
    }
    createTests() {
        this._tests = [];
        let sources = this._project.sources;
        this.globsAsRelativeGlobs(sources.declarationFilesGlobs.includes).forEach(glob => this._tests.push({ pattern: glob, ignore: true }));
        this.globsAsRelativeGlobs(sources.compiledFilesGlobs.includes).forEach(glob => this._tests.push({ pattern: glob, ignore: true }));
        this.globsAsRelativeGlobs(sources.testSetupFileGlobs.includes).forEach(glob => this._tests.push({ pattern: glob, ignore: true }));
        this.globsAsRelativeGlobs(sources.testFileGlobs.includes).forEach(glob => this._tests.push({ pattern: glob }));
    }
    createCompilers() {
        this._compilers = {};
        let sources = this._project.sources;
        this.globsAsRelativeGlobs(sources.sourceFileGlobs.includes).forEach(glob => {
            this._compilers[glob] = this._wallaby.compilers.typeScript({ module: 'cjs', downlevelIteration: true, experimentalDecorators: true, esModuleInterop: true });
        });
    }
    getBaseFiles() {
        let baseFiles = [{ pattern: 'package.json', instrument: false }];
        if (this._project.workspaces.length > 0) {
            baseFiles.push({ pattern: `${this.getRelativePathToSource()}/**/package.json`, instrument: false });
            baseFiles.push({ pattern: `${this.getRelativePathToSource()}/**/node_modules/**/*`, instrument: false });
        }
        return baseFiles.concat([
            { pattern: 'node_modules/chai/**/*', instrument: false },
            { pattern: 'node_modules/chai-as-promised/**/*', instrument: false },
            { pattern: 'node_modules/sinon/pkg/**/*', instrument: false },
            { pattern: 'node_modules/sinon-chai/**/*', instrument: false },
            { pattern: 'node_modules/@dolittle/typescript.build/**/*', instrument: false }
        ]);
    }
    globsAsRelativeGlobs(globs) {
        let root = process.platform === "win32"? this._project.sources.rootFolder.replace(/\\/g, `/`) : this._project.sources.rootFolder
        
        return globs.map(glob => glob.replace(`${root}/`, ''));
    }
    getRelativePathToSource() {
        let sourceFilesRoot = this._project.sources.sourceFilesRoot;
        let root = this._project.sources.rootFolder;
        return root === sourceFilesRoot ? '' : sourceFilesRoot.replace(`${root}${path_1.default.sep}`, '');
    }
}
exports.WallabySettings = WallabySettings;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2FsbGFieVNldHRpbmdzLmpzIiwic291cmNlUm9vdCI6Ii4vU291cmNlLyIsInNvdXJjZXMiOlsiV2FsbGFieS9TZXR0aW5ncy9XYWxsYWJ5U2V0dGluZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFNQSxnREFBd0I7QUFVeEIsTUFBYSxlQUFlO0lBS3hCLFlBQW9CLFFBQWEsRUFBVSxRQUFpQixFQUFVLE1BQW9CLEVBQVcsaUJBQTJDO1FBQTVILGFBQVEsR0FBUixRQUFRLENBQUs7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFTO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBYztRQUFXLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7UUFDNUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQUksUUFBUTtRQUNSLElBQUksUUFBUSxHQUFHO1lBQ1gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztZQUNqQixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSztZQUV4QixhQUFhLEVBQUUsT0FBTztZQUN0QixHQUFHLEVBQUU7Z0JBQ0QsSUFBSSxFQUFFLE1BQU07Z0JBQ1osTUFBTSxFQUFFLE1BQU07YUFDakI7U0FDSixDQUFDO1FBQ0YsSUFBSSxPQUFPLElBQUksQ0FBQyxpQkFBaUIsS0FBTSxVQUFVO1lBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDbkcsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQUksS0FBSztRQUNMLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTO1lBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2xELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ0wsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVM7WUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLFNBQVM7UUFDVCxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssU0FBUztZQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUMxRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVPLFdBQVc7UUFDZixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkksSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQztRQUNoSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQztRQUMzSCxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3BJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQztJQUNuSCxDQUFDO0lBRU8sV0FBVztRQUNmLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkksSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQztRQUNoSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQztJQUNqSCxDQUFDO0lBRU8sZUFBZTtRQUNuQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdkUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLGtCQUFrQixFQUFFLElBQUksRUFBRSxzQkFBc0IsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDaEssQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sWUFBWTtRQUNoQixJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUNoRSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDckMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxrQkFBa0IsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztZQUNsRyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixFQUFFLHVCQUF1QixFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO1NBQzFHO1FBQ0QsT0FBTyxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQ3BCLEVBQUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUM7WUFDdkQsRUFBRSxPQUFPLEVBQUUsb0NBQW9DLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRTtZQUNwRSxFQUFFLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFO1lBQzdELEVBQUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUU7WUFDOUQsRUFBRSxPQUFPLEVBQUUsOENBQThDLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRTtTQUNqRixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sb0JBQW9CLENBQUMsS0FBZTtRQUN4QyxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLGNBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQ2hHLENBQUM7SUFFTyx1QkFBdUI7UUFDM0IsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDO1FBQzVELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztRQUM1QyxPQUFPLElBQUksS0FBSyxlQUFlLENBQUEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksR0FBRyxjQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDNUYsQ0FBQztDQUVKO0FBaEdELDBDQWdHQyIsInNvdXJjZXNDb250ZW50IjpbIi8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4qICBDb3B5cmlnaHQgKGMpIERvbGl0dGxlLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuKiAgTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLiBTZWUgTElDRU5TRSBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxuKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cbmltcG9ydCB7IFByb2plY3QgfSBmcm9tIFwiQGRvbGl0dGxlL3R5cGVzY3JpcHQuYnVpbGRcIjtcbmltcG9ydCB7IFdhbGxhYnlTZXR1cCB9IGZyb20gXCIuLi8uLi9pbnRlcm5hbFwiO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbnR5cGUgV2FsbGFieUZpbGVQYXR0ZXJuID0gc3RyaW5nIHwge1xuICAgIHBhdHRlcm46IHN0cmluZywgXG4gICAgaW5zdHJ1bWVudD86IGJvb2xlYW4sIFxuICAgIGlnbm9yZT86IGJvb2xlYW5cbn07XG5cbmV4cG9ydCB0eXBlIFdhbGxhYnlTZXR0aW5nc0NhbGxiYWNrID0gKHdhbGxhYnk6IGFueSwgc2V0dGluZ3M6IGFueSkgPT4gdm9pZDtcblxuZXhwb3J0IGNsYXNzIFdhbGxhYnlTZXR0aW5ncyB7XG4gICAgcHJpdmF0ZSBfZmlsZXMhOiBXYWxsYWJ5RmlsZVBhdHRlcm5bXVxuICAgIHByaXZhdGUgX3Rlc3RzITogV2FsbGFieUZpbGVQYXR0ZXJuW11cbiAgICBwcml2YXRlIF9jb21waWxlcnMhOiBhbnlcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX3dhbGxhYnk6IGFueSwgcHJpdmF0ZSBfcHJvamVjdDogUHJvamVjdCwgcHJpdmF0ZSBfc2V0dXA6IFdhbGxhYnlTZXR1cCwgcHJpdmF0ZSAgX3NldHRpbmdzQ2FsbGJhY2s/OiBXYWxsYWJ5U2V0dGluZ3NDYWxsYmFjaykge1xuICAgICAgICB0aGlzLmNyZWF0ZUZpbGVzKCk7XG4gICAgICAgIHRoaXMuY3JlYXRlVGVzdHMoKTtcbiAgICAgICAgdGhpcy5jcmVhdGVDb21waWxlcnMoKTtcbiAgICB9XG5cbiAgICBnZXQgc2V0dGluZ3MoKSB7XG4gICAgICAgIGxldCBzZXR0aW5ncyA9IHtcbiAgICAgICAgICAgIGZpbGVzOiB0aGlzLmZpbGVzLFxuICAgICAgICAgICAgdGVzdHM6IHRoaXMudGVzdHMsXG4gICAgICAgICAgICBjb21waWxlcnM6IHRoaXMuY29tcGlsZXJzLFxuICAgICAgICAgICAgc2V0dXA6IHRoaXMuX3NldHVwLnNldHVwLFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0ZXN0RnJhbWV3b3JrOiAnbW9jaGEnLFxuICAgICAgICAgICAgZW52OiB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ25vZGUnLFxuICAgICAgICAgICAgICAgIHJ1bm5lcjogJ25vZGUnXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3NldHRpbmdzQ2FsbGJhY2sgID09PSAnZnVuY3Rpb24nKSB0aGlzLl9zZXR0aW5nc0NhbGxiYWNrKHRoaXMuX3dhbGxhYnksIHNldHRpbmdzKTtcbiAgICAgICAgcmV0dXJuIHNldHRpbmdzO1xuICAgIH1cblxuICAgIGdldCBmaWxlcygpIHtcbiAgICAgICAgaWYgKHRoaXMuX2ZpbGVzID09PSB1bmRlZmluZWQpIHRoaXMuY3JlYXRlRmlsZXMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbGVzO1xuICAgIH1cblxuICAgIGdldCB0ZXN0cygpIHtcbiAgICAgICAgaWYgKHRoaXMuX3Rlc3RzID09PSB1bmRlZmluZWQpIHRoaXMuY3JlYXRlVGVzdHMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rlc3RzO1xuICAgIH1cblxuICAgIGdldCBjb21waWxlcnMoKSB7XG4gICAgICAgIGlmICh0aGlzLl9jb21waWxlcnMgPT09IHVuZGVmaW5lZCkgdGhpcy5jcmVhdGVDb21waWxlcnMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbXBpbGVycztcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUZpbGVzKCkge1xuICAgICAgICB0aGlzLl9maWxlcyA9IFtdO1xuICAgICAgICB0aGlzLl9maWxlcy5wdXNoKC4uLnRoaXMuZ2V0QmFzZUZpbGVzKCkpO1xuICAgICAgICBsZXQgc291cmNlcyA9IHRoaXMuX3Byb2plY3Quc291cmNlcztcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLmRlY2xhcmF0aW9uRmlsZXNHbG9icy5pbmNsdWRlcykuZm9yRWFjaChnbG9iID0+IHRoaXMuX2ZpbGVzLnB1c2goe3BhdHRlcm46IGdsb2IsIGlnbm9yZTogdHJ1ZX0pKTtcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLmNvbXBpbGVkRmlsZXNHbG9icy5pbmNsdWRlcykuZm9yRWFjaChnbG9iID0+IHRoaXMuX2ZpbGVzLnB1c2goe3BhdHRlcm46IGdsb2IsIGlnbm9yZTogdHJ1ZX0pKTtcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLnRlc3RGaWxlR2xvYnMuaW5jbHVkZXMpLmZvckVhY2goZ2xvYiA9PiB0aGlzLl9maWxlcy5wdXNoKHtwYXR0ZXJuOiBnbG9iLCBpZ25vcmU6IHRydWV9KSk7XG4gICAgICAgIHRoaXMuZ2xvYnNBc1JlbGF0aXZlR2xvYnMoc291cmNlcy50ZXN0U2V0dXBGaWxlR2xvYnMuaW5jbHVkZXMpLmZvckVhY2goZ2xvYiA9PiB0aGlzLl9maWxlcy5wdXNoKHtwYXR0ZXJuOiBnbG9iLCBpbnN0cnVtZW50OiBmYWxzZX0pKVxuICAgICAgICB0aGlzLmdsb2JzQXNSZWxhdGl2ZUdsb2JzKHNvdXJjZXMuc291cmNlRmlsZUdsb2JzLmluY2x1ZGVzKS5mb3JFYWNoKGdsb2IgPT4gdGhpcy5fZmlsZXMucHVzaCh7cGF0dGVybjogZ2xvYn0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVRlc3RzKCkge1xuICAgICAgICB0aGlzLl90ZXN0cyA9IFtdO1xuICAgICAgICBsZXQgc291cmNlcyA9IHRoaXMuX3Byb2plY3Quc291cmNlcztcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLmRlY2xhcmF0aW9uRmlsZXNHbG9icy5pbmNsdWRlcykuZm9yRWFjaChnbG9iID0+IHRoaXMuX3Rlc3RzLnB1c2goe3BhdHRlcm46IGdsb2IsIGlnbm9yZTogdHJ1ZX0pKTtcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLmNvbXBpbGVkRmlsZXNHbG9icy5pbmNsdWRlcykuZm9yRWFjaChnbG9iID0+IHRoaXMuX3Rlc3RzLnB1c2goe3BhdHRlcm46IGdsb2IsIGlnbm9yZTogdHJ1ZX0pKTtcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLnRlc3RTZXR1cEZpbGVHbG9icy5pbmNsdWRlcykuZm9yRWFjaChnbG9iID0+IHRoaXMuX3Rlc3RzLnB1c2goe3BhdHRlcm46IGdsb2IsIGlnbm9yZTogdHJ1ZX0pKTtcbiAgICAgICAgdGhpcy5nbG9ic0FzUmVsYXRpdmVHbG9icyhzb3VyY2VzLnRlc3RGaWxlR2xvYnMuaW5jbHVkZXMpLmZvckVhY2goZ2xvYiA9PiB0aGlzLl90ZXN0cy5wdXNoKHtwYXR0ZXJuOiBnbG9ifSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQ29tcGlsZXJzKCkge1xuICAgICAgICB0aGlzLl9jb21waWxlcnMgPSB7fTtcbiAgICAgICAgbGV0IHNvdXJjZXMgPSB0aGlzLl9wcm9qZWN0LnNvdXJjZXM7XG4gICAgICAgIHRoaXMuZ2xvYnNBc1JlbGF0aXZlR2xvYnMoc291cmNlcy5zb3VyY2VGaWxlR2xvYnMuaW5jbHVkZXMpLmZvckVhY2goZ2xvYiA9PiB7XG4gICAgICAgICAgICB0aGlzLl9jb21waWxlcnNbZ2xvYl0gPSB0aGlzLl93YWxsYWJ5LmNvbXBpbGVycy50eXBlU2NyaXB0KHttb2R1bGU6ICdjanMnLCBkb3dubGV2ZWxJdGVyYXRpb246IHRydWUsIGV4cGVyaW1lbnRhbERlY29yYXRvcnM6IHRydWUsIGVzTW9kdWxlSW50ZXJvcDogdHJ1ZSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRCYXNlRmlsZXMoKSB7XG4gICAgICAgIGxldCBiYXNlRmlsZXMgPSBbeyBwYXR0ZXJuOiAncGFja2FnZS5qc29uJywgaW5zdHJ1bWVudDogZmFsc2V9XTtcbiAgICAgICAgaWYgKHRoaXMuX3Byb2plY3Qud29ya3NwYWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBiYXNlRmlsZXMucHVzaCh7cGF0dGVybjogYCR7dGhpcy5nZXRSZWxhdGl2ZVBhdGhUb1NvdXJjZSgpfS8qKi9wYWNrYWdlLmpzb25gLCBpbnN0cnVtZW50OiBmYWxzZX0pO1xuICAgICAgICAgICAgYmFzZUZpbGVzLnB1c2goe3BhdHRlcm46IGAke3RoaXMuZ2V0UmVsYXRpdmVQYXRoVG9Tb3VyY2UoKX0vKiovbm9kZV9tb2R1bGVzLyoqLypgLCBpbnN0cnVtZW50OiBmYWxzZX0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBiYXNlRmlsZXMuY29uY2F0KFtcbiAgICAgICAgICAgIHsgcGF0dGVybjogJ25vZGVfbW9kdWxlcy9jaGFpLyoqLyonLCBpbnN0cnVtZW50OiBmYWxzZX0sXG4gICAgICAgICAgICB7IHBhdHRlcm46ICdub2RlX21vZHVsZXMvY2hhaS1hcy1wcm9taXNlZC8qKi8qJywgaW5zdHJ1bWVudDogZmFsc2UgfSxcbiAgICAgICAgICAgIHsgcGF0dGVybjogJ25vZGVfbW9kdWxlcy9zaW5vbi9wa2cvKiovKicsIGluc3RydW1lbnQ6IGZhbHNlIH0sXG4gICAgICAgICAgICB7IHBhdHRlcm46ICdub2RlX21vZHVsZXMvc2lub24tY2hhaS8qKi8qJywgaW5zdHJ1bWVudDogZmFsc2UgfSxcbiAgICAgICAgICAgIHsgcGF0dGVybjogJ25vZGVfbW9kdWxlcy9AZG9saXR0bGUvdHlwZXNjcmlwdC5idWlsZC8qKi8qJywgaW5zdHJ1bWVudDogZmFsc2UgfVxuICAgICAgICBdKTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBnbG9ic0FzUmVsYXRpdmVHbG9icyhnbG9iczogc3RyaW5nW10pIHtcbiAgICAgICAgcmV0dXJuIGdsb2JzLm1hcChnbG9iID0+IGdsb2IucmVwbGFjZShgJHt0aGlzLl9wcm9qZWN0LnNvdXJjZXMucm9vdEZvbGRlcn0ke3BhdGguc2VwfWAsICcnKSlcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFJlbGF0aXZlUGF0aFRvU291cmNlKCkge1xuICAgICAgICBsZXQgc291cmNlRmlsZXNSb290ID0gdGhpcy5fcHJvamVjdC5zb3VyY2VzLnNvdXJjZUZpbGVzUm9vdDtcbiAgICAgICAgbGV0IHJvb3QgPSB0aGlzLl9wcm9qZWN0LnNvdXJjZXMucm9vdEZvbGRlcjtcbiAgICAgICAgcmV0dXJuIHJvb3QgPT09IHNvdXJjZUZpbGVzUm9vdD8gJycgOiBzb3VyY2VGaWxlc1Jvb3QucmVwbGFjZShgJHtyb290fSR7cGF0aC5zZXB9YCwgJycpO1xuICAgIH1cbiAgICBcbn1cbiJdfQ==
